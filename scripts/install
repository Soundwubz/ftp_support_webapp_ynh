#!/bin/bash

# Retrieve arguments
domain=$1
user=$2
language=$3

path=/ftp_webapp_$user
parent_dir=/var/www/webapp_$user
final_path=$parent_dir/netftp

# Check domain/path availability
sudo yunohost app checkurl $domain$path -a ftp_webapp
if [[ ! $? -eq 0 ]]; then
    exit 1
fi

# Check user
sudo yunohost user list --json | grep -q "\"username\": \"$user\""
if [[ ! $? -eq 0 ]]; then
echo "Wrong user"
    exit 1
fi
sudo yunohost app setting ftp_webapp ftp_user -v $user

# Créer le dossier parent des webapp pour l'utilisateur
if test ! -d $parent_dir
then	# Créer le dossier parent uniquement si il n'existe pas
    sudo mkdir -p $parent_dir

    # Set permissions
    sudo chmod 775 -R $parent_dir
    sudo chown -hR www-data:www-data $parent_dir
else
    echo "Création du dossier $parent_dir ignorée, le dossier existe déjà."
fi

# Vérifie si pure-ftpd est déjà installé
if test ! -f /usr/sbin/pure-ftpd-ldap
then # Installe Pure-ftpd uniquement si il ne l'est pas déjà
    # Check port availability
    sudo yunohost app checkport 21021
    if [[ ! $? -eq 0 ]]; then
    exit 1
    fi

    # Open port in firewall
    sudo yunohost firewall allow TCP 21021 > /dev/null 2>&1

    # Install debian dependencies
    sudo apt-get install pure-ftpd-ldap -y -qq

    # Change user ID in configurations
    sed -i "s@FTPUSER@$user@g" ../conf/ldap.conf
    sed -i "s@FTPDIR@$parent_dir@g" ../conf/ldap.conf

    # Adapt PureFTPd configuration
    sudo cp ../conf/ldap.conf /etc/pure-ftpd/db/
    sudo sh -c 'echo "yes" > /etc/pure-ftpd/conf/NoAnonymous'
    sudo sh -c 'echo "yes" > /etc/pure-ftpd/conf/ChrootEveryone'
    sudo sh -c 'echo "no" > /etc/pure-ftpd/conf/UnixAuthentication'
    sudo sh -c 'echo "50000 50100" > /etc/pure-ftpd/conf/PassivePortRange'
    sudo sh -c 'echo "21021" > /etc/pure-ftpd/conf/Bind'

    # Register service to YunoHost monitoring
    sudo yunohost service add pure-ftpd-ldap --log "/var/log/pure-ftpd/transfer.log"

    # Restart PureFTPd
    sudo service pure-ftpd-ldap restart
else
    echo "Installation de pure-ftpd ignorée, pure-ftpd est déjà installé."
fi

# Copie du client ftp net2ftp
sudo cp -r ../sources/net2ftp $parent_dir/netftp

# Copie des fichiers modifiés de net2ftp
sudo cp -r ../sources/net2ftp_modif/* $parent_dir/netftp/

# Détermine le nom du fichier de langue
case "$language" in
   "Arabic") language_file="ar"
   ;;
   "Arabic UTF-8") language_file="ar-utf"
   ;;
   "Simplified Chinese") language_file="zh"
   ;;
   "Traditional Chinese") language_file="tc"
   ;;
   "Czech") language_file="cs"
   ;;
   "Danish UTF-8") language_file="da"
   ;;
   "Dutch") language_file="nl"
   ;;
   "English") language_file="en"
   ;;
   "English UTF-8") language_file="en-utf"
   ;;
   "French") language_file="fr"
   ;;
   "German") language_file="de"
   ;;
   "Finnish") language_file="fi"
   ;;
   "Hebrew") language_file="he"
   ;;
   "Hungarian") language_file="hu"
   ;;
   "Hungarian UTF-8") language_file="hu-utf"
   ;;
   "Italian") language_file="it"
   ;;
   "Japanese") language_file="ja"
   ;;
   "Polish") language_file="pl"
   ;;
   "Portugese") language_file="pt"
   ;;
   "Russian") language_file="ru"
   ;;
   "Spanish") language_file="es"
   ;;
   "Swedish") language_file="sv"
   ;;
   "Turkish") language_file="tr"
   ;;
   "Ukrainian") language_file="ua"
   ;;
   "Vietnamese") language_file="vi"
   ;;
esac

# Configurer net2ftp
sed -i "s@__DOMAIN__@$domain@" ../conf/settings_authorizations.inc.php
sed -i "s@__LANG__@$language_file@" ../conf/settings.inc.php

# Copier les fichiers de config
sudo cp ../conf/settings_authorizations.inc.php $parent_dir/netftp/
sudo cp ../conf/settings.inc.php $parent_dir/netftp/

# Appliquer permissions à net2ftp
sudo chmod 775 -R $parent_dir/netftp
sudo chown -hR www-data:www-data $parent_dir/netftp

# Modify Nginx configuration file and copy it to Nginx conf directory for net2ftp
sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
sed -i "s@ALIASTOCHANGE@$parent_dir/netftp/@g" ../conf/nginx.conf
sed -i "s@NAMETOCHANGE@netftp@g" ../conf/nginx.conf
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/netftp_$user.conf

# Modify php-fpm pool configuration and copy it to php-fpm pool directory for net2ftp
sed -i "s@NAMETOCHANGE@netftp@g" ../conf/php-fpm.conf
sed -i "s@FINAL_PATH@$final_path@g" ../conf/php-fpm.conf
finalphpconf=/etc/php5/fpm/pool.d/netftp.conf
sudo cp ../conf/php-fpm.conf $finalphpconf
sudo chown root: $finalphpconf
finalphpini=/etc/php5/fpm/conf.d/20-netftp.ini
sudo cp ../conf/php-fpm.ini $finalphpini
sudo chown root: $finalphpini

# Reload Nginx and php, and regenerate SSOwat conf
sudo service nginx reload
sudo service php5-fpm reload
sudo yunohost app ssowatconf
