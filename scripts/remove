#!/bin/bash

# Récupère les infos de l'application.
ynh_version=$(sudo yunohost -v | grep "moulinette:" | cut -d' ' -f2 | cut -d'.' -f1,2)
if [ $ynh_version = "2.4" ]; then
	app=$YNH_APP_INSTANCE_NAME

	# Source app helpers
	source /usr/share/yunohost/helpers
else
	app=ftp_webapp
fi
admin=$(sudo yunohost app setting $app admin)
domain=$(sudo yunohost app setting $app domain)
port=$(sudo yunohost app setting $app port)
parent_dir=/var/www/webapp_$admin

# Suppression du dossier de l'application
if [ -e "$parent_dir/netftp" ]; then	# Delete final_path
	echo "Delete app dir"
	sudo rm -r "$parent_dir/netftp"
fi

# Suppression de la configuration nginx
if [ -e "/etc/nginx/conf.d/$domain.d/netftp_$admin.conf" ]; then	# Delete nginx config
	echo "Delete nginx config"
	sudo rm "/etc/nginx/conf.d/$domain.d/netftp_$admin.conf"
	sudo service nginx reload
fi

# Suppression de la configuration du pool php-fpm
if [ -e "/etc/php5/fpm/pool.d/$app.conf" ]; then	# Delete fpm config
	echo "Delete fpm config"
	sudo rm "/etc/php5/fpm/pool.d/$app.conf"
fi
if [ -e "/etc/php5/fpm/conf.d/20-$app.ini" ]; then	# Delete php config
	echo "Delete php config"
	sudo rm "/etc/php5/fpm/conf.d/20-$app.ini"
fi
sudo service php5-fpm reload

# Vérifie si le dossier parent est vide. Ce qui signifie que toutes les webapp ont été désinstallées. Ainsi que le client ftp net2ftp.
if [ -e "$parent_dir" ]
then
	if test -z "$(ls $parent_dir | head -n1)"
	then
		sudo rmdir "$parent_dir"
	fi
fi

# Vérifie si il reste encore au moins une instance de net2ftp dans un dossier de webapp
if [ -n "$domain" ]
then
	if test -z "$(ls /etc/nginx/conf.d/$domain.d/ | grep netftp_ | head -n1)"
	then	# Si il n'y a plus aucun net2ftp installé, désinstalle pure-ftpd
		sudo service pure-ftpd-ldap stop
		sudo apt-get purge -y -qq pure-ftpd-ldap pure-ftpd-common
	fi

	if sudo yunohost service status | grep -q pure-ftpd-ldap	# Test l'existence du service dans Yunohost
	then
		echo "Remove pure-ftpd-ldap service"
		sudo yunohost service remove pure-ftpd-ldap
	fi
fi

if sudo yunohost firewall list | grep -q "\- $port$"
then
	echo "Close port $port"
	sudo yunohost firewall disallow TCP $port > /dev/null
fi

# Suppression de la configuration de logrotate
if [ -e "/etc/logrotate.d/$app" ]; then
	echo "Delete logrotate config"
	sudo rm "/etc/logrotate.d/$app"
fi

# Régénère la configuration de SSOwat
sudo yunohost app ssowatconf

echo -e "\e[0m"	# Restore normal color
